<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="书后延伸：Flutter 中一行文字到屏幕上，渲染全过程！"><meta name="keywords" content="flutter,书后拓展"><meta name="author" content="Joker"><meta name="copyright" content="Joker"><title>书后延伸：Flutter 中一行文字到屏幕上，渲染全过程！ | Joker's Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><link rel="stylesheet" href="/css/iconfont.css?version=1.9.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '7.0.0'
} </script><meta name="generator" content="Hexo 7.0.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.</span> <span class="toc-text">正文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RenderParagraph"><span class="toc-number">2.</span> <span class="toc-text">RenderParagraph</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TextPainter"><span class="toc-number">3.</span> <span class="toc-text">TextPainter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E6%B8%B2%E6%9F%93%E5%BC%95%E6%93%8E"><span class="toc-number">4.</span> <span class="toc-text">文本渲染引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.</span> <span class="toc-text">最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB"><span class="toc-number">6.</span> <span class="toc-text">延伸阅读</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Joker</div><div class="author-info__description text-center">分享生活感悟、技术、学习心得</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">18</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">26</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">3</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Joker's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">目录</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/about">关于我</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">书后延伸：Flutter 中一行文字到屏幕上，渲染全过程！</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-24</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/flutter/">flutter</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>我要写的这一系列文章旨在<strong>分享一些我想要继续分享，但碍于<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/vO8UowK7A99J9aGb2se8cQ">《Flutter 开发之旅从南到北》</a>中篇幅和话题的限制，没有深入分析的部分</strong>，读者们可以在学有余力的情况下在这里继续拓展下去。</p>
<p>本文要讨论的话题是 <strong>Flutter 中的文本渲染</strong>，也假定你已经大致清楚了 Flutter 中 Widget、Element 和 RenderObject 等概念。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>在之前的文章中就有提及，Flutter 源码中除了无状态（StatelessWidget）和有状态（StatefluWidget）这两个直接继承自 Widget 的组件外，还存在其他另类的 Widget，如**可以用来统一传里状态的可遗传组件 <code>InheritedWidget</code>**、 **用于自渲染组件的 <code>RenderObjectWidget</code>**，关于 StatelessWidget 和 StatefluWidget 的相关内容，我相信大部分读者已经接触的足够多了，那么，今天我们就来一起探究一下 <code>RenderObjectWidget</code> 的奥妙，看看它是如何帮助我们渲染组件的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/meandni/blogimg@main/img/2020-11-24-widget.svg"></p>
<p>上图蓝色区域展示了 Flutter 内置的几种继承自 <code>RenderObjectWidget</code> 的组件，从名字就可以看出，<code>LeafRenderObjectWidget</code> 可用于自定义处于叶子结点组件的组件，而 <code>SingleChildRenderObjectWidget</code> 和 <code>MultiChildRenderObjectWidget</code> 就可以分别用来自定义具有单个或多个子组件的布局组件。</p>
<p>和 StatelessWidget、StatefluWidget 一样，<code>RenderObjectWidget</code> 并不负真正责组件的渲染工作，<strong>它依然是 Flutter 三棵树中组件树的一员，仅持有 Flutter 渲染组件的配置信息</strong>，不同的是，它可以实现 <code>createRenderObject</code> 方法直接创建 RenderObject 对象，这就给了我们一种可以渲染自定义组件的方式。</p>
<p>图 2 展示了 RenderObject 的所有子类，其中 RenderBox 最常被我们使用，它可以表示在组件间传递<strong>盒子约束</strong>的渲染对象，从而在屏幕中渲染出一个矩形块，在<strong>之前的文章</strong>中，我就通过使用它实现了一个自定义的居中布局组件。而 RenderBox 的子类 <code>RenderParagraph</code> 就是 Flutter <strong>专门用来渲染文本的渲染对象</strong>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/meandni/blogimg@main/img/2020-11-24-renderobject.svg"></p>
<p>依据以上描述，如果我们在 <code>RenderObjectWidget</code> 中使用  <code>RenderParagraph </code> 这个 RenderObject 对象就可以自定义一个自己的文本控件了，这就跟我们自定义居中布局组件一样简单，不一样的仅仅是，自定义文本组件使用的可能会是无子组件的 <code>LeafRenderObjectWidget</code>。</p>
<p>查看历史源码，Flutter 1.7 之前，专门用于渲染文本的 RichText 组件确实如我们预期继承自无子组件的 <code>LeafRenderObjectWidget</code>，而 Flutter 1.7 之后由于 RichText 也需要支持在内部嵌入 WidgetSpan 组件，实现图文混排的功能，因此改成了  <code>MultiChildRenderObjectWidget</code> 来实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//  1.7 以前</span><br><span class="line">class RichText extends LeafRenderObjectWidget &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//  1.7 以后</span><br><span class="line">class RichText extends MultiChildRenderObjectWidget &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这对我们探究如何渲染文本并没有阻碍。最终，在 RichText 内部， <code>RenderParagraph</code> 这个渲染对象也就随之在 <code>MultiChildRenderObjectWidget</code>  的 <code>createRenderObject</code> 方法中生成出来了，代码如下所示：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">RenderParagraph createRenderObject(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">assert</span>(textDirection != <span class="keyword">null</span> || debugCheckHasDirectionality(context));</span><br><span class="line">  <span class="keyword">return</span> RenderParagraph(text,</span><br><span class="line">    textAlign: textAlign,</span><br><span class="line">    textDirection: textDirection ?? Directionality.of(context),</span><br><span class="line">    softWrap: softWrap,</span><br><span class="line">    overflow: overflow,</span><br><span class="line">    textScaleFactor: textScaleFactor,</span><br><span class="line">    maxLines: maxLines,</span><br><span class="line">    strutStyle: strutStyle,</span><br><span class="line">    textWidthBasis: textWidthBasis,</span><br><span class="line">    textHeightBehavior: textHeightBehavior,</span><br><span class="line">    locale: locale ?? Localizations.localeOf(context, nullOk: <span class="keyword">true</span>),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RenderParagraph"><a href="#RenderParagraph" class="headerlink" title="RenderParagraph"></a>RenderParagraph</h3><p>将大致流程介绍完后，我们再往更深入探究，如下是 Flutter 整体架构图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/meandni/blogimg@main/img/2020-11-24-flutter_overview-650x319.png" alt="Flutter Architecture"></p>
<p><code>RenderObjectWidget</code> 作为一个普普通通的 widget，毫无疑问是处在架构图中 framework 的 <strong>Widget 层</strong>，然而它的渲染对象 <code>RenderParagraph</code> 就已经到了 Rendering 层了，走进 <code>RenderParagraph</code> 这个类，发现它就是直接继承自我们熟悉的 RenderBox：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderParagraph</span> <span class="keyword">extends</span> <span class="title">RenderBox</span></span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">ContainerRenderObjectMixin</span>&lt;<span class="title">RenderBox</span>, <span class="title">TextParentData</span>&gt;,</span></span><br><span class="line"><span class="class">             <span class="title">RenderBoxContainerDefaultsMixin</span>&lt;<span class="title">RenderBox</span>, <span class="title">TextParentData</span>&gt;,</span></span><br><span class="line"><span class="class">                  <span class="title">RelayoutWhenSystemFontsChangeMixin</span></span></span><br></pre></td></tr></table></figure>

<p>也就是说，它依然会接受<strong>盒子约束</strong>限制自己的宽高，他依然渲染的是一个矩形，只不过在矩形内部渲染的子组件是文本而已。</p>
<p>当然，<code>RenderParagraph</code> 作为渲染对象也并不是无所不能，他内部完成渲染文本的使命还主要依靠一个  <code>TextPainter</code> 类型的对象 <em>_textPainter</em>。在 <code>RenderParagraph</code> 的 performLayout 方法和 paint 方法中都使用到了 _textPainter 对象来实现文本的最终绘制，部分代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 负责布局</span></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> performLayout() &#123;</span><br><span class="line">  <span class="keyword">final</span> BoxConstraints constraints = <span class="keyword">this</span>.constraints;</span><br><span class="line">  _layoutTextWithConstraints(constraints);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取文本大小并布局子组件</span></span><br><span class="line">  <span class="keyword">final</span> Size textSize = _textPainter.size;</span><br><span class="line">  size = constraints.constrain(textSize);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 负责绘制</span></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> paint(PaintingContext context, Offset offset) &#123;</span><br><span class="line">  _textPainter.paint(context.canvas, offset);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以说， <code>TextPainter</code> 才是我们下一步要继续深挖的内容。</p>
<h3 id="TextPainter"><a href="#TextPainter" class="headerlink" title="TextPainter"></a>TextPainter</h3><p>到了 <code>TextPainter</code>  就处于架构图中 framework 的 <strong>Painting 层</strong>了，我们正一步一步逼近根源，在这里，Flutter 会将每种样式的文本分段构成 ui.Paragraph 对象 <code>_paragraph</code>， 每个 <code>ui.Paragraph</code> 对象又由 <code>ParagraphBuilder</code> 生成，<code>ParagraphBuilder</code> 可以接受一个 ui.ParagraphStyle 对象，主要用来配置每个 Paragraph 的最大行数、文本方向、截断方式等信息（在上层我们可以通过 TextStyle 来定义）。<code>TextPainter</code> 类中的 <code>_createParagraphStyle</code>  方法专门用来生成 ui.ParagraphStyle 对象，如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ui.ParagraphStyle _createParagraphStyle([ TextDirection defaultTextDirection ]) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> _text.style?.getParagraphStyle(</span><br><span class="line">    textAlign: textAlign,</span><br><span class="line">    textDirection: textDirection ?? defaultTextDirection,</span><br><span class="line">    textScaleFactor: textScaleFactor,</span><br><span class="line">    maxLines: _maxLines,</span><br><span class="line">    textHeightBehavior: _textHeightBehavior,</span><br><span class="line">    ellipsis: _ellipsis,</span><br><span class="line">    locale: _locale,</span><br><span class="line">    strutStyle: _strutStyle,</span><br><span class="line">  ) ?? ui.ParagraphStyle(</span><br><span class="line">    textAlign: textAlign,</span><br><span class="line">    textDirection: textDirection ?? defaultTextDirection,</span><br><span class="line">    maxLines: maxLines,</span><br><span class="line">    textHeightBehavior: _textHeightBehavior,</span><br><span class="line">    ellipsis: ellipsis,</span><br><span class="line">    locale: locale,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这段代码可以看出，用户如果没有自定义样式，<code>TextPainter</code> 也会为文本设置一个默认样式。ui.Paragraph 对象 _paragraph 就由此生成，下面就是 <code>TextPainter</code> 中 layout 方法的部分代码（该方法会在 <code>RenderParagraph</code> 布局内部文本时被调用）：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> layout(&#123; <span class="built_in">double</span> minWidth = <span class="number">0.0</span>, <span class="built_in">double</span> maxWidth = <span class="built_in">double</span>.infinity &#125;) &#123;</span><br><span class="line">  <span class="keyword">if</span> (_paragraph == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建具有特性样式的 ParagraphBuilder</span></span><br><span class="line">    <span class="keyword">final</span> ui.ParagraphBuilder builder = ui.ParagraphBuilder(_createParagraphStyle());</span><br><span class="line">    _text.build(builder, textScaleFactor: textScaleFactor, dimensions: _placeholderDimensions);</span><br><span class="line">    <span class="comment">// 创建出 ui.Paragraph 对象</span></span><br><span class="line">    _paragraph = builder.build();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，<code>TextPainter</code> 直接在 paint 方法中将生成的 _paragraph 对象传入 <code>canvas.drawParagraph</code> 就可以把文本在画布中渲染出来了：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> paint(Canvas canvas, Offset offset) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  canvas.drawParagraph(_paragraph, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，ParagraphBuilder 和 Paragraph 这两个类其实已经处于 framework 层中的最底层 Foundation 了，读者们也可以发现其中大部分的函数已经变成了在引擎层实现的空函数了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/meandni/blogimg@main/img/2020-11-24-image-20201001200742678.png" alt="image-20201001200742678"></p>
<h3 id="文本渲染引擎"><a href="#文本渲染引擎" class="headerlink" title="文本渲染引擎"></a>文本渲染引擎</h3><p>到这里，我们已经自顶向下走过了 Flutter 整个 framework 层了，由于引擎层代码主要使用 C&#x2F;C++ 编写，因此没办法在 Android Studio&#x2F;VSCode 直接阅读，感兴趣的读者们可以自己在本地编译一份 Flutter Engine 代码，也可以直接到官方仓库（<a target="_blank" rel="noopener" href="https://github.com/flutter/engine/%EF%BC%89%E5%9C%A8%E7%BA%BF%E9%98%85%E8%AF%BB%E3%80%82">https://github.com/flutter/engine/）在线阅读。</a></p>
<p>Flutter 引擎层用来渲染文本的引擎叫做 LibTxt，代码集中放在 <code>engine/third_party/txt/</code>  中，该库依赖了<a target="_blank" rel="noopener" href="https://github.com/flutter/engine/tree/master/third_party/txt/src/minikin">Minikin</a>、<a target="_blank" rel="noopener" href="http://site.icu-project.org/home">ICU</a>、<a target="_blank" rel="noopener" href="https://www.freedesktop.org/wiki/Software/HarfBuzz/">HarfBuzz</a>、<a target="_blank" rel="noopener" href="https://skia.org/">Skia</a> 等多个其他引擎库，内容比较庞大，我们暂不深究这一块内容。</p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>理论的描述终究还是有点抽象，下面我们就来自己定义一个用来渲染文本的组件，其中就涉及到了对 TextPainter 和 Paragraph 的改写，</p>
<p>我们要做的这个文本组件 Flutter 官方并未提供，他可以用来将传入的文本垂直展示，因为正好可以用来展示我们的中国诗词，所以我将它命名为了 <code>PoetryText</code>，使用方法如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PoetryText(</span><br><span class="line">  text: TextSpan(</span><br><span class="line">    text: <span class="string">&quot;床前明月光，疑似地上霜，举头望明月，低头思故乡。&quot;</span>,</span><br><span class="line">    style: TextStyle(</span><br><span class="line">      color: Colors.black,</span><br><span class="line">      fontSize: <span class="number">30</span>,</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p> 整体效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/meandni/blogimg@main/img/2020-11-23-image-20201123221936444.png"></p>
<p>如上所示，<code>PoetryText</code> 组件使用起来非常简单，接收一个 text 参数，传入一个特定样式的 TextSpan 即可，代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PoetryText</span> <span class="keyword">extends</span> <span class="title">LeafRenderObjectWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> PoetryText(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="keyword">this</span>.text,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> TextSpan text;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  RenderVerticalText createRenderObject(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> RenderVerticalText(text);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> updateRenderObject(</span><br><span class="line">      BuildContext context, RenderVerticalText renderObject) &#123;</span><br><span class="line">    renderObject.text = text;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PoetryText 继承自 LeafRenderObjectWidget，它的 <code>createRenderObject</code> 也方法返回一个我们自定义的渲染对象 <code>RenderVerticalText</code>，而这里的 updateRenderObject 方法主要用于 Widget 的配置更新。</p>
<p><code>RenderVerticalText</code> 的代码也很简单：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderVerticalText</span> <span class="keyword">extends</span> <span class="title">RenderBox</span> </span>&#123;</span><br><span class="line">  RenderVerticalText(TextSpan text)</span><br><span class="line">      : _textPainter = VerticalTextPainter(text: text);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> VerticalTextPainter _textPainter;</span><br><span class="line"></span><br><span class="line">  TextSpan <span class="keyword">get</span> text =&gt; _textPainter.text;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置渲染的文本内容</span></span><br><span class="line">  <span class="keyword">set</span> text(TextSpan value) &#123;</span><br><span class="line">    <span class="comment">// 比较新旧文本</span></span><br><span class="line">    <span class="keyword">switch</span> (_textPainter.text.compareTo(value)) &#123;</span><br><span class="line">      <span class="keyword">case</span> RenderComparison.identical:</span><br><span class="line">      <span class="keyword">case</span> RenderComparison.metadata:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> RenderComparison.paint:</span><br><span class="line">        _textPainter.text = value;</span><br><span class="line">        markNeedsPaint();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> RenderComparison.layout:</span><br><span class="line">        _textPainter.text = value;</span><br><span class="line">        markNeedsLayout();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 布局组件大小</span></span><br><span class="line">  <span class="keyword">void</span> _layoutText(&#123;</span><br><span class="line">    <span class="built_in">double</span> minHeight = <span class="number">0.0</span>,</span><br><span class="line">    <span class="built_in">double</span> maxHeight = <span class="built_in">double</span>.infinity,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _textPainter.layout(</span><br><span class="line">      minHeight: minHeight,</span><br><span class="line">      maxHeight: maxHeight,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _layoutTextWithConstraints(BoxConstraints constraints) &#123;</span><br><span class="line">    _layoutText(</span><br><span class="line">      minHeight: constraints.minHeight,</span><br><span class="line">      maxHeight: constraints.maxHeight,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算盒子最小高度</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">double</span> computeMinIntrinsicHeight(<span class="built_in">double</span> width) &#123;</span><br><span class="line">    _layoutText();</span><br><span class="line">    <span class="keyword">return</span> _textPainter.minIntrinsicHeight;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算盒子最大高度</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">double</span> computeMaxIntrinsicHeight(<span class="built_in">double</span> width) &#123;</span><br><span class="line">    _layoutText();</span><br><span class="line">    <span class="keyword">return</span> _textPainter.maxIntrinsicHeight;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> _computeIntrinsicWidth(<span class="built_in">double</span> height) &#123;</span><br><span class="line">    _layoutText(minHeight: height, maxHeight: height);</span><br><span class="line">    <span class="keyword">return</span> _textPainter.width;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算盒子最小宽度</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">double</span> computeMinIntrinsicWidth(<span class="built_in">double</span> height) &#123;</span><br><span class="line">    <span class="keyword">return</span> _computeIntrinsicWidth(height);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算盒子最大宽度</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">double</span> computeMaxIntrinsicWidth(<span class="built_in">double</span> height) &#123;</span><br><span class="line">    <span class="keyword">return</span> _computeIntrinsicWidth(height);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回从文本顶部到第一个基线的距离</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">double</span> computeDistanceToActualBaseline(TextBaseline baseline) &#123;</span><br><span class="line">    <span class="keyword">return</span> _textPainter.height;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 布局</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> performLayout() &#123;</span><br><span class="line">    _layoutTextWithConstraints(constraints);</span><br><span class="line">    <span class="keyword">final</span> Size textSize = _textPainter.size;</span><br><span class="line">    size = constraints.constrain(textSize);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 渲染</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> paint(PaintingContext context, Offset offset) &#123;</span><br><span class="line">    _textPainter.paint(context.canvas, offset);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个 RenderObject 都会经历 layout 和 paint 两个过程，如这里继承自 <code>RenderBox</code>   的   <code>RenderVerticalText</code> ，其中重写了一系列方法，在 <code>performLayout()</code> 和 <code>paint()</code> 分别用来做布局和渲染两个过程。</p>
<p>当然，在屏幕中渲染的任务还是主要交给了 VerticalTextPainter 类型的对象 _textPainter，它的代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/painting.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/dartui/vertical_paragraph.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/dartui/vertical_paragraph_builder.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/model/vertical_paragraph_constraints.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerticalTextPainter</span> </span>&#123;</span><br><span class="line">  VerticalTextPainter(&#123;TextSpan text&#125;) : _text = text;</span><br><span class="line"></span><br><span class="line">  VerticalParagraph _paragraph;</span><br><span class="line">  <span class="built_in">bool</span> _needsLayout = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  TextSpan <span class="keyword">get</span> text =&gt; _text;</span><br><span class="line">  TextSpan _text;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> text(TextSpan value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_text == value) <span class="keyword">return</span>;</span><br><span class="line">    _text = value;</span><br><span class="line">    _paragraph = <span class="keyword">null</span>;</span><br><span class="line">    _needsLayout = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> _applyFloatingPointHack(<span class="built_in">double</span> layoutValue) &#123;</span><br><span class="line">    <span class="keyword">return</span> layoutValue.ceilToDouble();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> minIntrinsicHeight &#123;</span><br><span class="line">    <span class="keyword">return</span> _applyFloatingPointHack(_paragraph.minIntrinsicHeight);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> maxIntrinsicHeight &#123;</span><br><span class="line">    <span class="keyword">return</span> _applyFloatingPointHack(_paragraph.maxIntrinsicHeight);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> width &#123;</span><br><span class="line">    <span class="keyword">return</span> _applyFloatingPointHack(_paragraph.width);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> height &#123;</span><br><span class="line">    <span class="keyword">return</span> _applyFloatingPointHack(_paragraph.height);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Size <span class="keyword">get</span> size &#123;</span><br><span class="line">    <span class="keyword">return</span> Size(width, height);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> _lastMinHeight;</span><br><span class="line">  <span class="built_in">double</span> _lastMaxHeight;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 供 RenderVerticalText 布局时调用</span></span><br><span class="line">  <span class="keyword">void</span> layout(&#123;<span class="built_in">double</span> minHeight = <span class="number">0.0</span>, <span class="built_in">double</span> maxHeight = <span class="built_in">double</span>.infinity&#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_needsLayout &amp;&amp;</span><br><span class="line">        minHeight == _lastMinHeight &amp;&amp;</span><br><span class="line">        maxHeight == _lastMaxHeight) <span class="keyword">return</span>;</span><br><span class="line">    _needsLayout = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (_paragraph == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> VerticalParagraphBuilder builder = VerticalParagraphBuilder(<span class="keyword">null</span>);</span><br><span class="line">      _applyTextSpan(builder, _text);</span><br><span class="line">      _paragraph = builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    _lastMinHeight = minHeight;</span><br><span class="line">    _lastMaxHeight = maxHeight;</span><br><span class="line">    <span class="comment">// 调用 _paragraph 的 layout 方法</span></span><br><span class="line">    _paragraph.layout(VerticalParagraphConstraints(height: maxHeight));</span><br><span class="line">    <span class="keyword">if</span> (minHeight != maxHeight) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">double</span> newHeight = maxIntrinsicHeight.clamp(minHeight, maxHeight);</span><br><span class="line">      <span class="keyword">if</span> (newHeight != height)</span><br><span class="line">        _paragraph.layout(VerticalParagraphConstraints(height: newHeight));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置 VerticalParagraphBuilder 参数</span></span><br><span class="line">  <span class="keyword">void</span> _applyTextSpan(VerticalParagraphBuilder builder, TextSpan textSpan) &#123;</span><br><span class="line">    <span class="keyword">final</span> style = textSpan.style;</span><br><span class="line">    <span class="keyword">final</span> text = textSpan.text;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> hasStyle = style != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (hasStyle) &#123;</span><br><span class="line">      builder.textStyle = style;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (text != <span class="keyword">null</span>) &#123;</span><br><span class="line">      builder.text = text;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 供 RenderVerticalText 绘制时调用</span></span><br><span class="line">  <span class="keyword">void</span> paint(Canvas canvas, Offset offset) &#123;</span><br><span class="line">    _paragraph.draw(canvas, offset);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该类源自 TextPainter，TextPainter 的默认的实现是将文本水平绘制，而这里我们就可以修改部分逻辑，通过传入的文本定义自己文本组件的宽高，实现垂直展示的文本组件。</p>
<p>与 Flutter 源码保持一致，我们再将任务交给与 Flutter 中 Paragraph 对应的 VerticalParagraph：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:math&#x27;</span> <span class="keyword">as</span> math;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:ui&#x27;</span> <span class="keyword">as</span> ui;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/painting.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/model/line_info.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/model/text_run.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/model/text_zi.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/model/vertical_paragraph_constraints.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:steppe_up/util/line_breaker.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerticalParagraph</span> </span>&#123;</span><br><span class="line">  VerticalParagraph(<span class="keyword">this</span>._paragraphStyle, <span class="keyword">this</span>._textStyle, <span class="keyword">this</span>._text);</span><br><span class="line"></span><br><span class="line">  ui.ParagraphStyle _paragraphStyle;</span><br><span class="line">  ui.TextStyle _textStyle;</span><br><span class="line">  <span class="built_in">String</span> _text;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> _width;</span><br><span class="line">  <span class="built_in">double</span> _height;</span><br><span class="line">  <span class="built_in">double</span> _minIntrinsicHeight;</span><br><span class="line">  <span class="built_in">double</span> _maxIntrinsicHeight;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> width =&gt; _width;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> height =&gt; _height;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> minIntrinsicHeight =&gt; _minIntrinsicHeight;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> <span class="keyword">get</span> maxIntrinsicHeight =&gt; _maxIntrinsicHeight;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;Word&gt; _words = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> layout(VerticalParagraphConstraints constraints) =&gt;</span><br><span class="line">      _layout(constraints.height);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _layout(<span class="built_in">double</span> height) &#123;</span><br><span class="line">    <span class="keyword">if</span> (height == _height) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> count = _text.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</span><br><span class="line">      _addWord(i);									<span class="comment">// 保存文本中的每个字</span></span><br><span class="line">    &#125;</span><br><span class="line">    _calculateLineBreaks(height);		<span class="comment">// 计算换行</span></span><br><span class="line">    _calculateWidth();							<span class="comment">// 计算宽度</span></span><br><span class="line">    _height = height;</span><br><span class="line">    _calculateIntrinsicHeight();		<span class="comment">// 计算高度</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _addWord(<span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">final</span> builder = ui.ParagraphBuilder(_paragraphStyle)</span><br><span class="line">      ..pushStyle(_textStyle)</span><br><span class="line">      ..addText(_text.substring(index, index + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">final</span> paragraph = builder.build();</span><br><span class="line">    paragraph.layout(ui.ParagraphConstraints(width: <span class="built_in">double</span>.infinity));</span><br><span class="line">    <span class="comment">// 将每个字都保存在一个 ui.Paragraph 对象中，并封装在 Word 放入 _words 列表</span></span><br><span class="line">    <span class="keyword">final</span> run = Word(index, paragraph);</span><br><span class="line">    _words.add(run);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;LineInfo&gt; _lines = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _calculateLineBreaks(<span class="built_in">double</span> maxLineLength) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_words.isEmpty) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (_lines.isNotEmpty) &#123;</span><br><span class="line">      _lines.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> start = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> end;</span><br><span class="line">    <span class="built_in">double</span> lineWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">double</span> lineHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 遍历之前保存的每一个 Word 对象</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i=<span class="number">0</span>; i&lt;_words.length; i++) &#123;</span><br><span class="line">      end = i;</span><br><span class="line">      <span class="keyword">final</span> word = _words[i];</span><br><span class="line">      <span class="keyword">final</span> wordWidth = word.paragraph.maxIntrinsicWidth;</span><br><span class="line">      <span class="keyword">final</span> wordHeight = word.paragraph.height;</span><br><span class="line">      <span class="comment">// 遇到 “，”、“。” 换行，保存每行的宽度和高度，调用 _addLine 放入 _lines 列表中</span></span><br><span class="line">      <span class="keyword">if</span> (_text.substring(i, i + <span class="number">1</span>) == <span class="string">&quot;，&quot;</span> || _text.substring(i, i + <span class="number">1</span>) == <span class="string">&quot;。&quot;</span>) &#123;</span><br><span class="line">        lineWidth += math.max(lineWidth, wordWidth);</span><br><span class="line">        _addLine(start, end+<span class="number">1</span>, lineWidth, lineHeight);</span><br><span class="line">        start = end + <span class="number">1</span>;</span><br><span class="line">        lineWidth = <span class="number">0</span>;</span><br><span class="line">        lineHeight = <span class="number">0</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 一行未结束，以竖直方向计算，该行的整体高度应该加上一个文字的高度</span></span><br><span class="line">        lineHeight += wordHeight;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    end = _words.length;</span><br><span class="line">    <span class="keyword">if</span> (start &lt; end) &#123;</span><br><span class="line">      _addLine(start, end, lineWidth, lineHeight);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _addLine(<span class="built_in">int</span> start, <span class="built_in">int</span> end, <span class="built_in">double</span> width, <span class="built_in">double</span> height) &#123;</span><br><span class="line">    <span class="keyword">final</span> bounds = Rect.fromLTRB(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    <span class="keyword">final</span> LineInfo lineInfo = LineInfo(start, end, bounds);</span><br><span class="line">    _lines.add(lineInfo);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 宽度为各行 “诗” 宽度的总和</span></span><br><span class="line">  <span class="keyword">void</span> _calculateWidth() &#123;</span><br><span class="line">    <span class="built_in">double</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (LineInfo line <span class="keyword">in</span> _lines) &#123;</span><br><span class="line">      sum += line.bounds.width;</span><br><span class="line">    &#125;</span><br><span class="line">    _width = sum;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 高度取诗中最长的一行（以竖直方向为高）</span></span><br><span class="line">  <span class="keyword">void</span> _calculateIntrinsicHeight() &#123;</span><br><span class="line">    <span class="built_in">double</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">double</span> maxRunHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (LineInfo line <span class="keyword">in</span> _lines) &#123;</span><br><span class="line">      sum += line.bounds.width;</span><br><span class="line">      maxRunHeight = math.max(line.bounds.height, maxRunHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    _minIntrinsicHeight = maxRunHeight;</span><br><span class="line">    _maxIntrinsicHeight = maxRunHeight;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算完每个文字和每行诗的宽高后，</span></span><br><span class="line">  <span class="comment">// 就可以在这里将文本绘制到 canvas 了。</span></span><br><span class="line">  <span class="keyword">void</span> draw(Canvas canvas, Offset offset) &#123;</span><br><span class="line">    canvas.save();</span><br><span class="line">    <span class="comment">// 移至开始绘制的位置</span></span><br><span class="line">    canvas.translate(offset.dx, offset.dy);</span><br><span class="line">    <span class="comment">// 绘制每一行</span></span><br><span class="line">    <span class="keyword">for</span> (LineInfo line <span class="keyword">in</span> _lines) &#123;</span><br><span class="line">      <span class="comment">// 移到绘制该行的开始处</span></span><br><span class="line">      canvas.translate(line.bounds.width + <span class="number">20</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="comment">// 遍历改行每一个 word</span></span><br><span class="line">      <span class="built_in">double</span> dy = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> i = line.textRunStart; i &lt; line.textRunEnd; i++) &#123;</span><br><span class="line">        <span class="comment">// 绘制每行诗中的文字 ui.Paragraph，偏移量为该字位于所在行的位置</span></span><br><span class="line">        canvas.drawParagraph(_words[i].paragraph, Offset(<span class="number">0</span>, dy));</span><br><span class="line">        dy += _words[i].paragraph.height;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    canvas.restore();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上代码所示，便可以真正的将传入的文本绘制在系统提供给我们的 canvas 中了，其中依附下层我们需要做的仅仅是将传入的文本使用 ui.ParagraphBuilder 封装在 ui.Paragraph 对象中，然后再绘制出将该对象传给 <code>canvas.drawParagraph()</code> 即可。</p>
<p>这样，我们自定义的 PoetryText 组件就完成了，包含的几个重要部分如下：</p>
<ul>
<li><u><a target="_blank" rel="noopener" href="https://github.com/MeandNi/flutter_poetry_text/blob/master/lib/widget/vertical_text.dart">PoetryText</a></u>，继承 LeafRenderObjectWidget 的 Widget。</li>
<li><u><a target="_blank" rel="noopener" href="https://github.com/MeandNi/flutter_poetry_text/blob/master/lib/widget/render_vertical_text.dart">RenderVerticalText</a></u>，继承 RenderBox 的组件 的 RenderObject。</li>
<li><u><a target="_blank" rel="noopener" href="https://github.com/MeandNi/flutter_poetry_text/blob/master/lib/dartui/vertical_text_painter.dart">VerticalTextPainter</a></u>，改写自 TextPainter。</li>
<li><u><a target="_blank" rel="noopener" href="https://github.com/MeandNi/flutter_poetry_text/blob/master/lib/dartui/vertical_paragraph.dart">VerticalParagraph</a></u>，改写自 Paragraph。</li>
</ul>
<p>完整代码，参见：<a target="_blank" rel="noopener" href="https://github.com/MeandNi/flutter_poetry_text">https://github.com/MeandNi/flutter_poetry_text</a></p>
<h3 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h3><p><strong>Flutter.cn</strong>：<a target="_blank" rel="noopener" href="https://api.flutter-io.cn/flutter/dart-ui/dart-ui-library.html">https://api.flutter-io.cn/flutter/dart-ui/dart-ui-library.html</a></p>
<hr>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/vO8UowK7A99J9aGb2se8cQ">我的新书《Flutter 开发之旅从南到北》终于和大家见面了！（抽奖送书啦）</a></p>
<p><strong>关注公众号「Meandni」，及时阅读最新前沿技术动态，不至于落后时代。</strong></p>
<img alt="扫一扫，关注「Meandni」" src="/images/qrcode_for_small.jpg" style="zoom:50%;" />

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Joker</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://meandni.com/2020/11/24/e009/">https://meandni.com/2020/11/24/e009/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://meandni.com">Joker's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/flutter/">flutter</a><a class="post-meta__tags" href="/tags/%E4%B9%A6%E5%90%8E%E6%8B%93%E5%B1%95/">书后拓展</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5ebb714f13e60e34" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/11/24/understanding-navigator-v2/"><i class="fa fa-chevron-left">  </i><span>Flutter Navigator 2.0 指南与原理解析</span></a></div><div class="next-post pull-right"><a href="/2020/11/16/my-book/"><span>我的新书《Flutter 开发之旅从南到北》终于和大家见面了。</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '12faa9d04b92d2d70968',
  clientSecret: 'ad1023eebffeb2972301ce0e730e0c277f64cf23',
  repo: 'MeandNi.github.io',
  owner: 'MeandNi',
  admin: 'MeandNi',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2024 By Joker</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>